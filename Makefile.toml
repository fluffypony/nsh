[config]
min_version = "0.37.24"

[tasks.format]
description = "Check code formatting"
command = "cargo"
args = ["fmt", "--", "--check"]

[tasks.format-fix]
description = "Auto-fix code formatting"
command = "cargo"
args = ["fmt"]

[tasks.check]
description = "Fast compilation check (no codegen)"
command = "cargo"
args = ["check", "--all-targets"]
dependencies = ["format"]

[tasks.lint]
description = "Run Clippy linter with warnings as errors"
command = "cargo"
args = ["clippy", "--all-targets", "--", "-D", "warnings"]
dependencies = ["check"]

[tasks.test]
description = "Run all tests"
command = "cargo"
args = ["test"]
dependencies = ["lint"]

[tasks.test-windows]
description = "Run tests on Windows (skip PTY tests)"
command = "cargo"
args = ["test", "--", "--skip", "pty", "--skip", "pump_loop"]
condition = { platforms = ["windows"] }

[tasks.audit]
description = "Check dependencies for known vulnerabilities"
install_crate = "cargo-audit"
install_crate_args = ["--locked"]
command = "cargo"
args = ["audit"]

[tasks.geiger]
description = "Report unsafe code usage in dependency tree"
install_crate = "cargo-geiger"
install_crate_args = ["--locked"]
command = "cargo"
args = ["geiger", "--output-format", "Ascii"]

[tasks.coverage]
description = "Generate test coverage report via cargo-tarpaulin"
install_crate = "cargo-tarpaulin"
install_crate_args = ["--locked"]
command = "cargo"
args = ["tarpaulin", "--engine", "llvm", "--skip-clean", "--timeout", "120"]

[tasks.quality]
description = "Run the full quality pipeline: format, check, lint, test, audit"
dependencies = [
    "test",
    "audit",
]

[tasks.quality-full]
description = "Run full quality pipeline including geiger unsafe audit"
dependencies = [
    "quality",
    "geiger",
]

[tasks.release-host]
description = "Build and package release artifact for current host target"
command = "bash"
args = ["scripts/release-builds.sh", "--host-only"]

[tasks.release-matrix]
description = "Build release artifacts for standard macOS/FreeBSD/Linux matrix"
command = "bash"
args = ["scripts/release-builds.sh"]

[tasks.sync-site-install]
description = "Copy install.sh and install.ps1 into ../nsh-site"
command = "bash"
args = ["scripts/sync-site-install.sh"]

[tasks.sync-site-install-watch]
description = "Watch installer scripts and mirror changes into ../nsh-site"
command = "bash"
args = ["scripts/sync-site-install.sh", "--watch"]
